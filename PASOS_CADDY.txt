═══════════════════════════════════════════════════════════════
  PASOS PARA CONFIGURAR CADDY CON WHATSAPP BOT
  Dominio: testbot.novapolointranet.xyz
═══════════════════════════════════════════════════════════════

🎯 OBJETIVO: Solucionar el error "ERROR AUTH" configurando Caddy
              correctamente como reverse proxy.

──────────────────────────────────────────────────────────────
PASO 1: COPIAR EL CADDYFILE OPTIMIZADO
──────────────────────────────────────────────────────────────

En tu VM de Google Cloud, ejecuta:

cd /ruta/a/tu/proyecto/bot
sudo cp Caddyfile /etc/caddy/Caddyfile


──────────────────────────────────────────────────────────────
PASO 2: VERIFICAR LA CONFIGURACIÓN DE CADDY
──────────────────────────────────────────────────────────────

sudo caddy validate --config /etc/caddy/Caddyfile

✅ Si dice "Valid configuration" continúa al siguiente paso
❌ Si hay errores, revisa el archivo Caddyfile


──────────────────────────────────────────────────────────────
PASO 3: LIMPIAR SESIONES ANTIGUAS
──────────────────────────────────────────────────────────────

cd /ruta/a/tu/proyecto/bot
docker-compose down
rm -rf base-js-baileys-json/bot_sessions/*
rm -f base-js-baileys-json/bot.qr.png


──────────────────────────────────────────────────────────────
PASO 4: INICIAR LOS CONTENEDORES
──────────────────────────────────────────────────────────────

docker-compose up -d


──────────────────────────────────────────────────────────────
PASO 5: RECARGAR CADDY
──────────────────────────────────────────────────────────────

sudo caddy reload --config /etc/caddy/Caddyfile

# O si prefieres reiniciar el servicio:
sudo systemctl reload caddy


──────────────────────────────────────────────────────────────
PASO 6: ESPERAR 30 SEGUNDOS
──────────────────────────────────────────────────────────────

sleep 30

# Esto permite que:
# - Los contenedores inicien completamente
# - El bot genere el código QR
# - Caddy obtenga el certificado SSL (si es la primera vez)


──────────────────────────────────────────────────────────────
PASO 7: VERIFICAR QUE TODO ESTÉ FUNCIONANDO
──────────────────────────────────────────────────────────────

# Verificar contenedores
docker ps | grep bot_service

# Verificar API local
curl http://localhost:3009/status

# Verificar dominio (debería responder con JSON)
curl https://testbot.novapolointranet.xyz/status


──────────────────────────────────────────────────────────────
PASO 8: ACCEDER AL QR
──────────────────────────────────────────────────────────────

Abre tu navegador en:

    https://testbot.novapolointranet.xyz

⚠️ IMPORTANTE: Usa HTTPS (no HTTP)
⚠️ Caddy obtiene certificados SSL automáticamente


──────────────────────────────────────────────────────────────
PASO 9: ESCANEAR EL QR RÁPIDAMENTE
──────────────────────────────────────────────────────────────

ANTES de abrir la página web, prepara tu teléfono:

1. Abre WhatsApp en tu teléfono
2. Ve a: Configuración > Dispositivos vinculados
3. Toca: "Vincular un dispositivo"
4. AHORA abre la página web
5. Escanea el QR EN MENOS DE 60 SEGUNDOS

⏱️ El QR expira cada 60 segundos, así que debes ser rápido


──────────────────────────────────────────────────────────────
PASO 10: VERIFICAR AUTENTICACIÓN
──────────────────────────────────────────────────────────────

# Ver estado en el navegador
# La página debería mostrar: "✅ Bot autenticado correctamente"

# O verificar por comando:
curl https://testbot.novapolointranet.xyz/status

# Debería responder:
# {"qrAvailable":false,"authenticated":true,"message":"Bot autenticado correctamente"}


══════════════════════════════════════════════════════════════
🎉 ¡LISTO! EL BOT ESTÁ AUTENTICADO
══════════════════════════════════════════════════════════════

La sesión se guarda en: base-js-baileys-json/bot_sessions/
No necesitarás escanear el QR nuevamente a menos que:
  • Elimines la carpeta bot_sessions/
  • Desvincules el dispositivo desde WhatsApp
  • El contenedor se reinicie sin volúmenes persistentes


──────────────────────────────────────────────────────────────
🔧 SCRIPT DE DIAGNÓSTICO (OPCIONAL)
──────────────────────────────────────────────────────────────

Si algo no funciona, ejecuta el script de diagnóstico:

chmod +x diagnostico-caddy.sh
./diagnostico-caddy.sh

Este script verificará:
  ✅ Docker instalado y corriendo
  ✅ Contenedores activos
  ✅ Puertos abiertos
  ✅ Caddy configurado correctamente
  ✅ Conectividad al dominio
  ✅ Estado de autenticación


──────────────────────────────────────────────────────────────
🆘 SOLUCIÓN DE PROBLEMAS
──────────────────────────────────────────────────────────────

PROBLEMA: Error 502 Bad Gateway
SOLUCIÓN:
  docker ps | grep bot_service
  docker logs bot_service
  docker-compose restart bot

PROBLEMA: Error 504 Gateway Timeout
SOLUCIÓN:
  # Ya está configurado en el Caddyfile con timeouts de 30s
  # Verifica que el bot esté corriendo:
  docker logs -f bot_service

PROBLEMA: El QR no aparece
SOLUCIÓN:
  # Espera 30 segundos más
  sleep 30
  # Refresca la página (F5)
  # Verifica logs:
  docker logs bot_service | grep -i qr

PROBLEMA: Sigue mostrando "ERROR AUTH"
SOLUCIÓN:
  # Limpia TODO y empieza de nuevo:
  docker-compose down
  rm -rf base-js-baileys-json/bot_sessions/*
  rm -f base-js-baileys-json/bot.qr.png
  docker-compose up -d
  sleep 30
  # Accede a https://testbot.novapolointranet.xyz
  # Escanea RÁPIDAMENTE (menos de 60 segundos)

PROBLEMA: El dominio no responde
SOLUCIÓN:
  # Verifica que el DNS apunte a tu servidor:
  nslookup testbot.novapolointranet.xyz
  
  # Verifica que Caddy esté corriendo:
  sudo systemctl status caddy
  
  # Verifica logs de Caddy:
  sudo journalctl -u caddy -f

PROBLEMA: Certificado SSL no se obtiene
SOLUCIÓN:
  # Verifica que los puertos 80 y 443 estén abiertos:
  sudo netstat -tuln | grep -E ":80|:443"
  
  # Verifica firewall de Google Cloud:
  gcloud compute firewall-rules list | grep caddy
  
  # Caddy necesita puerto 80 para obtener certificados


──────────────────────────────────────────────────────────────
📚 DOCUMENTACIÓN COMPLETA
──────────────────────────────────────────────────────────────

• CONFIGURACION_CADDY.md  - Guía completa de Caddy
• SOLUCION_RAPIDA.md      - Resumen ejecutivo
• INSTRUCCIONES_QR.md     - Guía detallada del QR
• COMANDOS_UTILES.txt     - Comandos útiles
• diagnostico-caddy.sh    - Script de diagnóstico


──────────────────────────────────────────────────────────────
🔍 COMANDOS DE VERIFICACIÓN RÁPIDA
──────────────────────────────────────────────────────────────

# Ver logs del bot
docker logs -f bot_service

# Ver logs de Caddy
sudo journalctl -u caddy -f

# Estado de autenticación
curl https://testbot.novapolointranet.xyz/status

# Ver contenedores
docker ps

# Reiniciar todo
docker-compose restart && sudo systemctl reload caddy


──────────────────────────────────────────────────────────────
📊 ARQUITECTURA FINAL
──────────────────────────────────────────────────────────────

Internet
    ↓
  HTTPS (443)
    ↓
Caddy Reverse Proxy
    ↓
    ├─→ / → localhost:3009 (Interfaz web QR)
    ├─→ /qr → localhost:3009 (Imagen QR)
    ├─→ /status → localhost:3009 (Estado)
    ├─→ /conversations → localhost:3009 (Conversaciones)
    ├─→ /api/* → localhost:3009 (API)
    └─→ /dashboard* → localhost:3000 (Dashboard)
    
Docker:
    ├─→ bot_service:3009 (Bot + API)
    └─→ dashboard_service:3000 (Next.js)


──────────────────────────────────────────────────────────────
✅ CHECKLIST FINAL
──────────────────────────────────────────────────────────────

Antes de escanear el QR, verifica:

□ Caddyfile copiado a /etc/caddy/
□ Configuración de Caddy validada
□ Sesiones antiguas eliminadas
□ Contenedores corriendo (docker ps)
□ Caddy recargado
□ Puerto 3009 responde (curl localhost:3009/status)
□ Dominio responde (curl https://testbot.novapolointranet.xyz/status)
□ Certificado SSL obtenido (https:// funciona)
□ Página web del QR carga correctamente
□ QR visible en la página

Si todos los checks están ✅, escanea el QR rápidamente.


═══════════════════════════════════════════════════════════════
  ¿Necesitas ayuda? Ejecuta: ./diagnostico-caddy.sh
═══════════════════════════════════════════════════════════════
